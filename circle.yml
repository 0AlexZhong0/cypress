machine:
  node:
    version: 6.5.0

dependencies:
  # CircleCI caching
  # https://circleci.com/docs/1.0/how-cache-works/
  cache_directories:
    # downloaded Electron binary
    - "~/.electron"
    # could not use wildcard format, so list every subfolder
    - packages/coffee/node_modules
    - packages/desktop-gui/node_modules
    - packages/driver/node_modules
    - packages/electron/node_modules
    - packages/example/node_modules
    - packages/extension/node_modules
    - packages/https-proxy/node_modules
    - packages/launcher/node_modules
    - packages/reporter/node_modules
    - packages/runner/node_modules
    - packages/server/node_modules
    - packages/socket/node_modules
    - packages/static/node_modules

test:
  ## e2e (1)
  ## desktop-gui (2)
  ## driver (3)
  ## example (4)
  ## cli (5)
  ## extension (5)
  ## https-proxy (5)
  ## launcher (5)
  ## reporter (5)
  ## runner (5)
  ## server (5, 6)
  override:
    #
    # things to run in the 1st CI container
    #
    # run unit tests (fast)
    # separate commands for better GUI view
    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package coffee; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package desktop-gui; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package driver; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package electron; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package extension; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package https-proxy; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package launcher; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package reporter; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package runner; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package server; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package socket; fi:
        parallel: true

    - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm run all test -- --package static; fi:
        parallel: true

    #
    # things to run in the 2nd CI container
    #
    - if [ $CIRCLE_NODE_INDEX == 1 ]; then npm run all test-integration-once -- --package server; fi:
        parallel: true

    #
    # things to run in the 3rd CI container
    #
    - if [ $CIRCLE_NODE_INDEX == 2 ]; then npm run all test-e2e-once -- --package server; fi:
        parallel: true

    # Example project E2E tests
    # Hanging now, so commented out
    # - if [ $CIRCLE_NODE_INDEX == 0 ]; then npm start -- --project ../example/; fi:
    #     parallel: true
