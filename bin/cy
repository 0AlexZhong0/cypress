#!/usr/bin/env node
require("coffee-script/register")

// var nodemon = require('nodemon')
var path    = require('path')
var spawn   = require("child_process").spawn
var open    = require("open")

// console.log("args are", process.argv)

var cyRoot   = path.join(__dirname, "..", "lib");
var cyServer = path.join(__dirname, "..", "lib", "cypress.coffee");

// need to add --debug here

var getArgs = function(){
  var args = ["--", process.argv[2], "verbose"]

  if (process.argv[3] != "--no-ids")
    args.push("id_generator")

  return args
}

var opts = {
  debug: "--debug",
  script: cyServer,
  watch: ["--watch", cyRoot],
  ignore: ["--ignore", "lib/public"],
  verbose: "--verbose",
  exts: ["-e", "coffee,js"],
  args: getArgs()
}

var args = []

for (key in opts)
  args = args.concat(opts[key])

spawn("nodemon", args, {stdio: "inherit"})

if (process.argv.indexOf("--no-debug") === -1){
  spawn("node-inspector", [], {stdio: "inherit"})

  open("http://127.0.0.1:8080/debug?ws=127.0.0.1:8080&port=5858")
}

// nodemon(cyServer)
