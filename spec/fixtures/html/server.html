<!doctype html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>.Only Tests</title>
    <link rel="icon" href="data:;base64,=">
    <script type="text/javascript" src="/lib/public/js/iframe.js"></script>
    <script type="text/javascript">
      describe("server", function(){
        beforeEach(function(){
          cy
            .server()
            .route(/foo/, {foo: "bar"}).as("getFoo")
            .visit("/fixtures/html/sinon.html")
        })
        it("t1", function(){
          cy.wait("@getFoo").its("url").should("include", "?some=data")
        })

        it("t2", function(){
          cy.wait("@getFoo").its("url").should("include", "?some=data")
        })

        it("t3", function(){
          cy.wait("@getFoo").its("url").should("include", "?some=data")
        })
      })

      describe("server with 1 visit", function(){
        before(function(){
          cy.visit("/fixtures/html/sinon.html")
        })

        beforeEach(function(){
          cy
            .server()
            .route(/users/, [{}, {}]).as("getUsers")
        })

        it("t4", function(){
          cy
            .get("#fetch").click()
            .wait("@getUsers").then(function(xhr){
              expect(xhr.url).to.include("/users")
              expect(xhr.responseBody).to.deep.eq([{}, {}])
            })
        })

        it("t5", function(){
          cy
            .route("POST", /users/, {name: "b"}).as("createUser")
            .get("#create").click()
            .wait("@createUser").its("requestBody").should("deep.eq", {some: "data"})
        })

        // we can probably move this out of this integration
        // test and into the normal command tests since this
        // is testing a different feature
        it("t6", function(){
          cy
            .route({
              method: "POST",
              url: /users/,
              response: {name: "b"},
              delay: 200
            }).as("createUser")
            .get("#create").click()
            .then(function(){
              // simulate an open request which should become
              // aborted (usually due to moving to next test)
              Cypress.trigger("test:before:hooks", {id: 123})
            })
            .wait("@createUser").its("aborted").should("be.true")
        })
      })
    </script>
  </head>
  <body>
    Server Integration Specs
  </body>
</html>